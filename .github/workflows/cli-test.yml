name: cli lint
on:
  pull_request:
    paths:
      - 'apps/cli/**'
  workflow_dispatch:
jobs:
  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./apps/cli
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
      - name: Install base dependencies (python, mafft, ...)
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          channels: conda-forge,bioconda
          conda-remove-defaults: "true"
          activate-environment: "sonar-cli"
          environment-file: apps/cli/environment.yml
          python-version: 3.11
          auto-activate-base: false
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          # Install a specific version of uv.
          version: "0.6.13"
          enable-cache: true
          cache-dependency-glob: "apps/cli/uv.lock"
      - name: Install the project
        run: uv sync --locked --dev
      - name: Run cli pytest tests that don't require the backend
        run: uv run --locked pytest -m clionly
